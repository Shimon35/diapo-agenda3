<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Diaporama Agenda</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: Arial, sans-serif;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #slide {
      max-width: 900px;
      max-height: 600px;
      text-align: center;
    }
    #slide img {
      max-width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 0 20px rgba(255,255,255,0.2);
      background: #000;
    }
    h2 {
      margin: 0 0 10px;
      font-size: 2em;
    }
    .date {
      font-style: italic;
      margin-bottom: 15px;
      color: #aaa;
    }
    .description {
      font-size: 1.1em;
      line-height: 1.4em;
      max-height: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <div id="slide">
    <img id="slide-image" src="" alt="Image événement" />
    <h2 id="slide-title"></h2>
    <div class="date" id="slide-date"></div>
    <div class="description" id="slide-description"></div>
  </div>

  <script>
    function getImageUrl(ev) {
      // 1. Cas image directe
      if (ev.image) {
        if (typeof ev.image === 'string') {
          return ev.image.startsWith('http') ? ev.image : 'https://cdn.openagenda.com/' + ev.image;
        } else if (ev.image.original) {
          return ev.image.original.startsWith('http') ? ev.image.original : 'https://cdn.openagenda.com/' + ev.image.original;
        } else if (ev.image.url) {
          return ev.image.url.startsWith('http') ? ev.image.url : 'https://cdn.openagenda.com/' + ev.image.url;
        }
      }

      // 2. Cas attachments
      if (ev.attachments && ev.attachments.length > 0) {
        const firstAttach = ev.attachments[0];
        if (typeof firstAttach === 'string') {
          return firstAttach.startsWith('http') ? firstAttach : 'https://cdn.openagenda.com/' + firstAttach;
        } else if (firstAttach.url) {
          return firstAttach.url.startsWith('http') ? firstAttach.url : 'https://cdn.openagenda.com/' + firstAttach.url;
        }
      }

      // 3. Cas fallback sur image de l’agenda
      if (ev.originAgenda && ev.originAgenda.image) {
        return ev.originAgenda.image.startsWith('http') 
          ? ev.originAgenda.image 
          : 'https://cdn.openagenda.com/main/' + ev.originAgenda.image;
      }

      return null;
    }

    function formatDate(ev) {
      if (!ev.timings || ev.timings.length === 0) return '';
      const t = ev.timings[0];
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      const d1 = new Date(t.begin);
      const d2 = t.end ? new Date(t.end) : null;
      if (d2 && d2.getTime() !== d1.getTime()) {
        return d1.toLocaleDateString('fr-FR', options) + ' - ' + d2.toLocaleDateString('fr-FR', options);
      }
      return d1.toLocaleDateString('fr-FR', options);
    }

    fetch('agenda.json')
      .then(response => response.json())
      .then(data => {
        const events = data.events || [];
        let index = 0;

        function showSlide(i) {
          const ev = events[i];
          if (!ev) return;

          const imgUrl = getImageUrl(ev) || '';
          document.getElementById('slide-image').src = imgUrl;
          document.getElementById('slide-image').alt = ev.title?.fr || 'Image événement';
          document.getElementById('slide-title').textContent = ev.title?.fr || '';
          document.getElementById('slide-date').textContent = formatDate(ev);
          document.getElementById('slide-description').textContent = ev.description?.fr || '';
        }

        function nextSlide() {
          showSlide(index);
          index = (index + 1) % events.length;
        }

        nextSlide();
        setInterval(nextSlide, 8000);
      })
      .catch(err => {
        document.getElementById('slide').textContent = 'Erreur de chargement des événements.';
        console.error('Erreur:', err);
      });
  </script>

</body>
</html>


