<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Diaporama Agenda</title>
  <style>
    body {
      margin: 0; 
      background: #111; 
      color: white; 
      font-family: Arial, sans-serif;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #slide {
      max-width: 900px;
      max-height: 600px;
      text-align: center;
    }
    #slide img {
      max-width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 0 20px rgba(255,255,255,0.2);
    }
    h2 {
      margin: 0 0 10px;
      font-size: 2em;
    }
    .date {
      font-style: italic;
      margin-bottom: 15px;
      color: #aaa;
    }
  </style>
</head>
<body>

  <div id="slide">
    <img id="slide-image" src="" alt="Image événement" />
    <h2 id="slide-title"></h2>
    <div class="date" id="slide-date"></div>
  </div>

  <script>
    function getImageUrl(ev) {
      if(ev.image && ev.image.base && ev.image.variants) {
        const full = ev.image.variants.find(v => v.type === "full");
        if(full) return ev.image.base + full.filename;
      }
      if(ev.image && typeof ev.image === 'string') {
        return ev.image;
      }
      if(ev.originAgenda && ev.originAgenda.image) {
        return 'https://cdn.openagenda.com/main/' + ev.originAgenda.image;
      }
      return null;
    }

    function formatDateTime(ev) {
      if(!ev.timings || ev.timings.length === 0) return '';
      const t = ev.timings[0];
      const d1 = new Date(t.begin);
      const d2 = t.end ? new Date(t.end) : null;

      const dateOptions = { year: 'numeric', month: 'short', day: 'numeric' };
      const timeOptions = { hour: '2-digit', minute: '2-digit' };

      let result = d1.toLocaleDateString('fr-FR', dateOptions) + " " + d1.toLocaleTimeString('fr-FR', timeOptions);
      if(d2 && d2.getTime() !== d1.getTime()) {
        result += " - " + d2.toLocaleTimeString('fr-FR', timeOptions);
      }
      return result;
    }

    fetch('agenda.json')
      .then(response => response.json())
      .then(data => {
        let events = data.events || [];

        const categoriesFilter = ["rencontre", "concert", "spectacle"];
        const now = new Date();
        const maxDate = new Date();
        maxDate.setDate(maxDate.getDate() + 60);

        events = events.filter(ev => {
          let catList = [];

          if (ev.category && ev.category.fr) {
            catList.push(ev.category.fr.toLowerCase());
          }
          if (ev.tags && ev.tags.fr && Array.isArray(ev.tags.fr)) {
            catList = catList.concat(ev.tags.fr.map(c => c.toLowerCase()));
          }

          const hasCategory = categoriesFilter.some(f => 
            catList.some(c => c.includes(f))
          );
          if(!hasCategory) return false;

          if(!ev.timings || ev.timings.length === 0) return false;
          const beginDate = new Date(ev.timings[0].begin);
          return beginDate >= now && beginDate <= maxDate;
        });

        // Tri par date de début
        events.sort((a, b) => new Date(a.timings[0].begin) - new Date(b.timings[0].begin));

        let index = 0;
        function showSlide(i) {
          const ev = events[i];
          if(!ev) return;

          const imgUrl = getImageUrl(ev) || '';
          document.getElementById('slide-image').src = imgUrl;
          document.getElementById('slide-title').textContent = ev.title?.fr || '';
          document.getElementById('slide-date').textContent = formatDateTime(ev);
        }

        function nextSlide() {
          showSlide(index);
          index = (index + 1) % events.length;
        }

        if(events.length > 0) {
          nextSlide();
          setInterval(nextSlide, 8000);
        } else {
          document.getElementById('slide').textContent = "Aucun événement correspondant trouvé.";
        }
      })
      .catch(err => {
        document.getElementById('slide').textContent = 'Erreur de chargement des événements.';
        console.error('Erreur:', err);
      });
  </script>

</body>
</html>

